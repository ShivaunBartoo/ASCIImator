var S=n=>{throw TypeError(n)};var E=(n,e,t)=>e.has(n)||S("Cannot "+t);var f=(n,e,t)=>(E(n,e,"read from private field"),t?t.call(n):e.get(n)),b=(n,e,t)=>e.has(n)?S("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),g=(n,e,t,a)=>(E(n,e,"write to private field"),a?a.call(n,t):e.set(n,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const I=1.75,O=1.25;class F{constructor(e,t,a,s=1){this.element=e,this.width=t,this.height=a,this.scale=s,this.initCanvas()}toString(){let e="";return this.element.querySelectorAll(".canvas-cell").forEach(t=>{e+=t.textContent}),e}toJSON(){let e={width:this.width,height:this.height,cells:[]};return this.element.querySelectorAll(".canvas-cell").forEach(t=>{e.cells.push(t.textContent)}),e}fromJSON(e){if(!this.JSONisValid(e))throw new Error("Invalid JSON format");this.width=e.width,this.height=e.height,this.initCanvas();let t=this.element.querySelectorAll(".canvas-cell");for(let a=0;a<t.length;a++)t[a].textContent=e.cells[a];this.dispatchCanvasUpdatedEvent()}JSONisValid(e){return typeof e!="object"||e===null?(console.error("Invalid JSON: The input is not an object or is null."),!1):typeof e.width!="number"||e.width<=0?(console.error("Invalid JSON: 'width' must be a positive number. Received:",e.width),!1):typeof e.height!="number"||e.height<=0?(console.error("Invalid JSON: 'height' must be a positive number. Received:",e.height),!1):Array.isArray(e.cells)?e.cells.length!==e.width*e.height?(console.error(`Invalid JSON: 'cells' length (${e.cells.length}) does not match 'width' x 'height' (${e.width} x ${e.height}).`),!1):!0:(console.error("Invalid JSON: 'cells' must be an array."),!1)}initCanvas(){this.element.innerHTML=this.getCanvasHTML(),this.styleCanvasSize()}getCanvasHTML(){let e="<table class='canvas'>";for(let t=0;t<this.height;t++){e+="<tr>";for(let a=0;a<this.width;a++)e+=`<td class="canvas-cell" data-x="${a}" data-y="${t}" style="width: ${I}ch; height: ${O}em;"> </td>`;e+="</tr>"}return e+="</table>",e}styleCanvasSize(){this.element.style.transform=`scale(${this.scale})`,this.element.style.width=`${this.width*I}ch`,this.element.style.height=`${this.height*O}em`}setCell(e,t,a){if(e<0||e>=this.width||t<0||t>=this.height)return!1;const s=this.element.querySelector(`.canvas-cell[data-x="${e}"][data-y="${t}"]`);return s?(s.textContent=a,this.dispatchCanvasUpdatedEvent(),!0):!1}dispatchCanvasUpdatedEvent(){const e=new CustomEvent("CanvasUpdated",{detail:{canvas:this},bubbles:!0,composed:!0});this.element.dispatchEvent(e)}}let c=null,u=null,N=!1;class U extends F{constructor(e,t,a,s){super(e,t,a,s),this.addInteractionEvents()}initCanvas(){super.initCanvas(),this.addInteractionEvents()}addInteractionEvents(){this.element.querySelectorAll(".canvas-cell").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),this.selectCell(e),u=this})}),N||(document.addEventListener("keydown",$),document.addEventListener("click",e=>{c&&(c.classList.remove("selected"),c=null,u=null)}),N=!0)}selectCell(e){c&&c.classList.remove("selected"),c=e,c.classList.add("selected")}moveSelection(e){if(!c)return;let t=parseInt(c.getAttribute("data-x")),a=parseInt(c.getAttribute("data-y"));switch(e){case"ArrowUp":a>0&&a--;break;case"ArrowDown":a<c.parentElement.parentElement.children.length-1&&a++;break;case"ArrowLeft":t>0&&t--;break;case"ArrowRight":t<c.parentElement.children.length-1&&t++;break}const s=c.parentElement.parentElement.children[a];if(s){const i=s.children[t];i&&this.selectCell(i)}}}function $(n){!c||!u||(n.key&&n.key.length===1?(c.textContent=n.key,u.dispatchCanvasUpdatedEvent()):n.key==="ArrowUp"||n.key==="ArrowDown"||n.key==="ArrowLeft"||n.key==="ArrowRight"?(n.preventDefault(),u.moveSelection(n.key)):n.key==="Backspace"&&(c.textContent=" ",u.dispatchCanvasUpdatedEvent()))}class q{constructor(e,t,a){this.container=document.querySelector(e),this.canvasWidth=t,this.canvasHeight=a,this.canvases=[]}async initialize(e){return await this.addCanvas(e)}async addCanvas(e){return fetch("../html/editableCanvas.html").then(t=>t.text()).then(t=>{let a=document.createElement("template");a.innerHTML=t;let s=[];for(let i=0;i<e;i++){let o=a.content.firstElementChild.cloneNode(!0);this.container.appendChild(o);let d=o.querySelector(".canvas"),v=new U(d,this.canvasWidth,this.canvasHeight,1);this.canvases.push(v),s.push(v),v.dispatchCanvasUpdatedEvent()}return this.updateNavigationButtons(),s})}deleteCanvas(e,t=1){for(let a=0;a<t;a++)if(this.canvases.length==1)e.initCanvas();else{let s=this.getCanvasIndex(e);s!==-1&&this.canvases.splice(s,1),e.element.closest(".canvas-container").remove()}this.updateNavigationButtons()}swapCanvas(e,t){let s=this.getCanvasIndex(e)+t;if(s>=0&&s<this.canvases.length){let i=this.canvases[s],o=i.toJSON();i.fromJSON(e.toJSON()),e.fromJSON(o),e.dispatchCanvasUpdatedEvent(),i.dispatchCanvasUpdatedEvent()}}getFrames(){return this.canvases.map(e=>e.toJSON())}getElementCanvas(e){return this.canvases.find(t=>t.element===e)}getEventCanvas(e){return this.getElementCanvas(e.target.closest(".canvas-container").querySelector(".canvas"))}getCanvasIndex(e){return this.canvases.findIndex(t=>t===e)}updateNavigationButtons(){this.container.querySelectorAll(".canvas-container").forEach((e,t)=>{const a=e.querySelector(".left-button"),s=e.querySelector(".right-button");t===0?a.classList.add("disabled"):a.classList.remove("disabled"),t===this.canvases.length-1?s.classList.add("disabled"):s.classList.remove("disabled")})}}var h;class J extends F{constructor(t,a,s,i,o,d){super(t,a,s,i);b(this,h);g(this,h,Array.isArray(o)?o:[]),this.fps=d,this.currentFrameIndex=0,this.intervalId=null}toJSON(){return{fps:Number(this.fps),frames:f(this,h)}}fromJSON(t){if(!this.JSONanimationIsValid(t))throw new Error("Invalid JSON format");this.fps=t.fps,g(this,h,t.frames),this.currentFrameIndex=0,this.play()}async fromFile(t){try{const a=await fetch(t);if(!a.ok)throw new Error(`Failed to fetch file: ${a.status}`);const s=await a.json();if(this.JSONanimationIsValid(s))this.fromJSON(s);else throw new Error("Invalid file.")}catch(a){console.error("Error loading file:",a)}}setFrame(t){t>=0&&t<f(this,h).length&&(this.currentFrameIndex=t,super.fromJSON(f(this,h)[t]))}nextFrame(){this.setFrame(this.currentFrameIndex<f(this,h).length-1?this.currentFrameIndex+1:0)}JSONanimationIsValid(t){if(typeof t!="object"||t===null)return console.error("Invalid JSON: Expected an object."),!1;if(isNaN(Number(t.fps))||Number(t.fps)<=0)return console.error("Invalid JSON: 'fps' should be a positive number."),!1;if(!Array.isArray(t.frames))return console.error("Invalid JSON: 'frames' should be an array."),!1;for(let a of t.frames)if(!super.JSONisValid(a))return console.error("Invalid JSON: One or more frames are invalid."),!1;return!0}setFrames(t){if(!Array.isArray(t))throw new Error("Frames should be an array");for(const a of t)if(!super.JSONisValid(a))throw new Error("Invalid frame format");g(this,h,t)}setFPS(t){this.fps=t,this.play()}play(){this.intervalId&&clearInterval(this.intervalId),this.setFrame(this.currentFrameIndex),this.intervalId=setInterval(()=>this.nextFrame(),1e3/this.fps)}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)}getFrameCount(){return f(this,h).length}}h=new WeakMap;const r=new q("#canvases",12,8),p=document.querySelector("#anim-canvas"),B=document.querySelector("#too-small-canvas"),k=new J(B,12,8,1,[{}],6),D="../json/sleepy_cat.json",l=new J(p,12,8,2,[{}],6);let m=!1;M();async function M(){P(),H(),V(),T(),await _(),R(),k.fromFile(D),m=!1}async function R(){const n=localStorage.getItem("pendingAnimation");if(n)try{const e=JSON.parse(n);await w(e),m=!1,localStorage.removeItem("pendingAnimation")}catch(e){console.error("Error loading pending animation:",e)}}function P(){document.addEventListener("CanvasUpdated",n=>{if(n.detail.canvas!==l&&n.detail.canvas!==k)try{const e=r.getFrames();l.setFrames(e),m=!0}catch(e){console.error("Error updating frames:",e)}})}function H(){const n=document.getElementById("fps"),e=document.getElementById("fps-value");e.textContent=n.value,n.addEventListener("input",function(){e.textContent=n.value,l.setFPS(n.value)})}function V(){document.addEventListener("click",n=>{n.target.closest(".add-button")?W():n.target.closest(".delete-button")?G(n):n.target.closest(".copy-button")?K(n):n.target.closest(".left-button")?A(n,-1):n.target.closest(".right-button")?A(n,1):n.target.closest("#open-gallery")?z():n.target.closest("#save-to-disk")?X():n.target.closest("#load-from-disk")?Q():n.target.closest("#clear-animation")?Z():n.target.closest("#save-gif")&&j()})}function T(){let n=document.querySelector("#confirmation-dialogue");if(n){let e=()=>{n.style.visibility="",typeof n._action=="function"&&(n._action(),n._action=null)};n&&(n.addEventListener("click",t=>{t.target.closest("#cancel")&&(n.style.visibility=""),t.target.closest("#confirm")&&e()}),n.addEventListener("keydown",t=>{console.log(t.key),t.key==="Escape"&&(n.style.visibility=""),t.key==="Enter"&&e()}))}else console.error("Confirmation dialogue element not found in the DOM.")}async function _(){await r.initialize(3),l.play()}async function z(){m?L(`Are you sure you want to leave this page? 
        All usaved changes will be lost.`,()=>window.location.href="./gallery.html"):window.location.href="./gallery.html"}function W(){r.addCanvas(1),l.setFrames(r.getFrames())}function G(n){let e=r.getEventCanvas(n);e?(r.deleteCanvas(e),l.setFrames(r.getFrames())):console.error("Canvas instance not found for element")}function K(n){let e=r.getEventCanvas(n),t=r.getCanvasIndex(e),a=e.toJSON();r.addCanvas(1).then(([s])=>{s.fromJSON(a);for(let i=r.canvases.length-1;i>t+1;i--)r.swapCanvas(r.canvases[i],-1)})}function A(n,e){let t=r.getEventCanvas(n);t?r.swapCanvas(t,e):console.error("Canvas instance not found for element")}async function Y(n){if(n.trim()===""){console.error("Invalid file name provided");return}try{const e=await fetch(n);if(!e.ok)throw new Error(`Failed to fetch file: ${e.statusText}`);const t=await e.json();if(l.JSONanimationIsValid(t))await w(t);else throw new Error("Invalid JSON format")}catch(e){console.error("Error loading animation from file:",e)}}async function w(n){if(!l.JSONanimationIsValid(n))throw new Error("Invalid JSON format");const e=n.frames,t=n.fps,a=document.getElementById("fps"),s=document.getElementById("fps-value");a.value=t,s.textContent=t,l.setFPS(t);let i=e.length;if(r.canvases.length<i)await r.addCanvas(i-r.canvases.length);else if(i<r.canvases.length){let o=r.canvases.length-i;for(let d=0;d<o;d++)r.deleteCanvas(r.canvases[r.canvases.length-1])}r.canvases.forEach((o,d)=>{e[d]&&o.fromJSON(e[d])}),l.setFrames(r.getFrames()),l.play()}function Q(){const n=document.createElement("input");n.type="file",n.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const a=new FileReader;a.onload=()=>{const s=JSON.parse(a.result);w(s)},a.readAsText(t)}),n.click()}function X(){console.log("Save to Disk clicked");const n=l.toJSON(),e=new Blob([JSON.stringify(n)],{type:"application/json"}),t=new Date,a=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),o=String(t.getHours()).padStart(2,"0"),d=String(t.getMinutes()).padStart(2,"0"),v=String(t.getSeconds()).padStart(2,"0"),x=`${a}-${s}-${i}_${o}-${d}-${v}`,y=document.createElement("a"),C=URL.createObjectURL(e);y.href=C,y.download=`animation_${x}.json`,y.click(),URL.revokeObjectURL(C)}function Z(){let n=async()=>{await Y("../json/empty.json"),m=!1};m?L(`Are you sure you want to clear the current animation? 
            All usaved changes will be lost.`,n):n()}function L(n,e){let t=document.querySelector("#confirmation-dialogue");t?(t.querySelector("#confirmation-message").innerHTML=n,t._action=e,t.style.visibility="visible",t.tabIndex=-1,t.focus()):console.error("Dialogue not found")}async function j(){p.offsetWidth,p.offsetHeight;var n=new GIF({workers:2,quality:10,workerScript:"/node_modules/gif.js/dist/gif.worker.js"});const e=1e3/l.fps;l.stop(),l.setFrame(0);const t=[];for(let a=0;a<l.getFrameCount();a++)t.push(html2canvas(p).then(s=>{n.addFrame(s,{delay:e})}).catch(s=>{})),l.nextFrame();await Promise.all(t),n.on("finished",function(a){const s=URL.createObjectURL(a),i=document.createElement("a");i.href=s,i.download="animation.gif",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}),n.render(),l.play()}
